---
import Layout from '../../layouts/Layout.astro';
import { getAlbum, getAlbumTracks } from '../../lib/spotify'; // Asegúrate de tener estas funciones
import type { SpotifyTrack } from '../../types/spotify';

const { id } = Astro.params;

if (!id) return Astro.redirect('/404');

const album = await getAlbum(id);
const tracks = await getAlbumTracks(id);

if (!album) return Astro.redirect('/404');

const releaseYear = album.release_date.split('-')[0];

const formatDuration = (ms: number) => {
  const min = Math.floor(ms / 60000);
  const sec = Math.floor((ms % 60000) / 1000);
  return `${min}:${sec.toString().padStart(2, '0')}`;
};
---

<Layout title={`${album.name} - ${album.artists[0].name}`}>
  <header class="relative mb-12 flex flex-col md:flex-row items-center md:items-end gap-8 pt-4">
    <div class="relative flex-shrink-0 group">
      <img 
        src={album.images[0]?.url} 
        alt={album.name}
        class="h-64 w-64 md:h-72 md:w-72 object-cover rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] border border-white/10 transition-transform duration-500 group-hover:scale-[1.02]"
        transition:name={`album-image-${album.id}`}
      />
    </div>

    <div class="flex flex-col gap-3 text-center md:text-left pb-2">
      <span class="text-[#1DB954] text-[10px] font-black uppercase tracking-[0.2em]">
        {album.album_type === 'single' ? 'Sencillo' : 'Álbum'}
      </span>
      <h1 
        class="text-4xl md:text-6xl font-black tracking-tighter text-white"
        transition:name={`album-name-${album.id}`}
      >
        {album.name}
      </h1>
      <div class="flex items-center justify-center md:justify-start gap-2 text-sm font-medium">
        <img src={album.artists[0].images?.[0]?.url} class="h-6 w-6 rounded-full" alt="" />
        <a href={`/artists/${album.artists[0].id}`} class="text-white hover:underline font-bold">
          {album.artists[0].name}
        </a>
        <span class="text-zinc-600">•</span>
        <span class="text-zinc-400">{releaseYear}</span>
        <span class="text-zinc-600">•</span>
        <span class="text-zinc-400">{album.total_tracks} canciones</span>
      </div>
    </div>
  </header>

  <spotify-tracklist class="flex flex-col rounded-3xl border border-zinc-800/40 bg-zinc-900/10 overflow-hidden mb-20">
    <div class="grid grid-cols-[16px_1fr_100px] gap-4 px-6 py-4 border-b border-zinc-800/50 text-[10px] font-black uppercase tracking-widest text-zinc-500">
      <span>#</span>
      <span>Título</span>
      <span class="text-right">Duración</span>
    </div>

    <div class="divide-y divide-zinc-800/30">
      {tracks.map((track: any, index: number) => (
        <button 
          class="track-row group grid grid-cols-[16px_1fr_100px] items-center gap-4 px-6 py-4 transition-all duration-500 hover:bg-[#1DB954]/5 text-left w-full"
          data-name={track.name}
          data-artist={album.artists[0].name}
          data-image={album.images[0]?.url}
        >
          <span class="text-xs font-bold text-zinc-600 group-hover:text-[#1DB954] transition-colors">
            {index + 1}
          </span>
          
          <div class="flex flex-col min-w-0">
            <span class="truncate text-sm font-bold text-zinc-200 group-hover:text-white transition-colors">
              {track.name}
            </span>
            <span class="truncate text-[11px] font-medium text-zinc-500">
              {track.artists.map((a: any) => a.name).join(', ')}
            </span>
          </div>

          <div class="flex items-center justify-end gap-4">
            {track.explicit && <span class="text-[8px] font-black bg-zinc-800 text-zinc-500 px-1.5 py-0.5 rounded-sm">E</span>}
            <span class="text-xs text-zinc-500 font-mono">
              {formatDuration(track.duration_ms)}
            </span>
          </div>
        </button>
      ))}
    </div>
  </spotify-tracklist>
</Layout>

<script>
  // El script es idéntico al de RecentTracks. 
  // Al usar Custom Elements, el navegador reutilizará la definición si ya existe.
  class SpotifyTracklist extends HTMLElement {
    constructor() {
      super();
      this.addEventListener('click', (e) => {
        const btn = (e.target as HTMLElement).closest('.track-row') as HTMLElement;
        if (!btn) return;

        const detail = {
          name: btn.dataset.name,
          artist: btn.dataset.artist,
          image: btn.dataset.image
        };

        document.dispatchEvent(new CustomEvent('spotify:play', { detail }));
      });
    }
  }

  if (!customElements.get('spotify-tracklist')) {
    customElements.define('spotify-tracklist', SpotifyTracklist);
  }
</script>