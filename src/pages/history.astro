---
import Layout from '../layouts/Layout.astro';
import { getRecentlyPlayed } from '../lib/spotify';

const url = new URL(Astro.url);
const limitParam = Number(url.searchParams.get('limit')) || 10;
const currentLimit = [10, 20, 50].includes(limitParam) ? limitParam : 10;

const trackItems = await getRecentlyPlayed(currentLimit);
---

<Layout title="Historial | Archive">
  <div class="max-w-5xl mx-auto px-6"> 
    
    <header class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-8">
      <div class="space-y-2">
        <div class="flex items-center gap-2">
           <div class="h-[2px] w-6 bg-[#1DB954]"></div>
           <span class="text-[10px] font-black uppercase tracking-[0.4em] text-[#1DB954]">Dashboard</span>
        </div>
        <h1 class="text-6xl font-black text-white tracking-tighter">Historial</h1>
        <p class="text-zinc-500 text-sm font-medium max-w-md">
          Explora tu actividad reciente. Los datos se actualizan en tiempo real con tu cuenta de Spotify.
        </p>
      </div>

      <div class="flex items-center bg-zinc-900/40 p-1 rounded-xl border border-zinc-800/50 backdrop-blur-sm">
        { [10, 20, 50].map((num) => (
          <a
            href={`/history?limit=${num}`}
            class={`px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${
              currentLimit === num 
                ? 'bg-zinc-100 text-black' 
                : 'text-zinc-500 hover:text-white hover:bg-white/5'
            }`}
          >
            {num}
          </a>
        ))}
      </div>
    </header>

    <spotify-tracklist class="block rounded-2xl border border-zinc-800/40 bg-zinc-900/10 overflow-hidden shadow-2xl">
      <div class="grid grid-cols-[48px_1fr_100px] md:grid-cols-[48px_2fr_1fr_100px] gap-4 px-6 py-4 border-b border-zinc-800/50 text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 bg-white/[0.02]">
        <div class="flex justify-center">#</div>
        <div>Título</div>
        <div class="hidden md:block">Álbum</div>
        <div class="text-right">Hora</div>
      </div>

      <div class="flex flex-col">
        {trackItems.map((item, index) => {
          const { track } = item;
          const artistNames = track.artists.map(a => a.name).join(', ');
          
          return (
            <button 
              class="track-row group grid grid-cols-[48px_1fr_100px] md:grid-cols-[48px_2fr_1fr_100px] items-center gap-4 px-6 py-3 transition-all hover:bg-white/[0.04] text-left border-b border-zinc-800/10 last:border-0"
              data-name={track.name}
              data-artist={artistNames}
              data-image={track.album.images[0]?.url}
            >
              <div class="flex items-center justify-center relative">
                <span class="text-[11px] font-bold text-zinc-600 group-hover:opacity-0 transition-opacity">
                  {(index + 1).toString().padStart(2, '0')}
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="absolute hidden group-hover:block text-[#1DB954] animate-in fade-in zoom-in duration-200"><path d="M8 5v14l11-7z"/></svg>
              </div>

              <div class="flex items-center gap-4 min-w-0">
                <div class="relative h-10 w-10 flex-shrink-0">
                  <img src={track.album.images[0]?.url} class="h-full w-full rounded shadow-md object-cover" alt="" />
                  <div class="absolute inset-0 ring-1 ring-inset ring-white/10 rounded"></div>
                </div>
                <div class="flex flex-col min-w-0">
                  <span class="truncate text-sm font-bold text-zinc-200 group-hover:text-white transition-colors">{track.name}</span>
                  <span class="truncate text-[11px] font-semibold text-zinc-500 group-hover:text-[#1DB954] transition-colors">{artistNames}</span>
                </div>
              </div>

              <div class="hidden md:block truncate text-xs font-medium text-zinc-500">
                {track.album.name}
              </div>

              <div class="text-[10px] font-mono text-zinc-600 text-right font-bold uppercase">
                {new Date(item.played_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </div>
            </button>
          );
        })}
      </div>
    </spotify-tracklist>
  </div>
</Layout>

<script>
  // Reutilizamos el Custom Element SpotifyTracklist
  if (!customElements.get('spotify-tracklist')) {
    customElements.define('spotify-tracklist', class extends HTMLElement {
      constructor() {
        super();
        this.addEventListener('click', (e) => {
          const btn = (e.target as HTMLElement).closest('.track-row') as HTMLElement;
          if (!btn) return;
          document.dispatchEvent(new CustomEvent('spotify:play', { 
            detail: { ...btn.dataset } 
          }));
        });
      }
    });
  }
</script>