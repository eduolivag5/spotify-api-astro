---
import { getRecentlyPlayed } from '../lib/spotify';


interface Props {
  limit?: number;
}

const { limit = 10 } = Astro.props;
const trackItems = await getRecentlyPlayed(limit);
---

<spotify-tracklist class="block rounded-3xl border border-white/5 bg-zinc-900/20 backdrop-blur-sm overflow-hidden">
  <div class="grid grid-cols-[48px_1fr_100px] md:grid-cols-[48px_2fr_1fr_100px] gap-4 px-6 py-4 border-b border-white/5 text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 bg-white/[0.02]">
    <div class="flex justify-center">#</div>
    <div>Título</div>
    <div class="hidden md:block">Álbum</div>
    <div class="text-right">Hora</div>
  </div>

  <div class="flex flex-col">
    {trackItems.map((item, index) => {
      const { track } = item;
      const artistNames = track.artists.map(a => a.name).join(', ');
      
      return (
        <button 
          class="track-row group grid grid-cols-[48px_1fr_100px] md:grid-cols-[48px_2fr_1fr_100px] items-center gap-4 px-6 py-3 transition-all hover:bg-white/[0.05] text-left border-b border-white/[0.02] last:border-0"
          data-name={track.name}
          data-artist={artistNames}
          data-image={track.album.images[0]?.url}
        >
          <div class="flex items-center justify-center relative">
            <span class="text-[11px] font-bold text-zinc-600 group-hover:opacity-0 transition-opacity">
              {(index + 1).toString().padStart(2, '0')}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="absolute hidden group-hover:block text-[#1DB954] animate-in fade-in zoom-in duration-200">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>

          <div class="flex items-center gap-4 min-w-0">
            <img src={track.album.images[0]?.url} class="h-10 w-10 rounded shadow-lg object-cover flex-shrink-0" alt="" />
            <div class="flex flex-col min-w-0">
              <span class="truncate text-sm font-black text-white">{track.name}</span>
              <span class="truncate text-[11px] font-bold text-zinc-500 group-hover:text-[#1DB954] transition-colors">
                {artistNames}
              </span>
            </div>
          </div>

          <div class="hidden md:block truncate text-xs font-bold text-zinc-500">
            {track.album.name}
          </div>

          <div class="text-[10px] font-mono text-zinc-600 text-right font-black uppercase">
            {new Date(item.played_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </div>
        </button>
      );
    })}
  </div>
</spotify-tracklist>

<script>
  if (!customElements.get('spotify-tracklist')) {
    customElements.define('spotify-tracklist', class extends HTMLElement {
      constructor() {
        super();
        this.addEventListener('click', (e) => {
          const btn = (e.target as HTMLElement).closest('.track-row') as HTMLElement;
          if (!btn) return;
          
          // Despachamos el evento que escucha tu Player.astro
          document.dispatchEvent(new CustomEvent('spotify:play', { 
            detail: { 
              name: btn.dataset.name,
              artist: btn.dataset.artist,
              image: btn.dataset.image
            } 
          }));
        });
      }
    });
  }
</script>