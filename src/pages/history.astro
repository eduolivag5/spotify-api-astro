---
import { getRecentlyPlayed } from '../lib/spotify';
import Layout from '../layouts/Layout.astro';
import TrackList from '../components/tracks/TrackList.astro';
import type { RecentlyPlayed } from '../types/spotify';

// Pedimos el máximo (50) para poder filtrar en cliente sin nuevas peticiones
const trackItems = await getRecentlyPlayed(50) as RecentlyPlayed['items'];

// Mapeamos los datos para que TrackList los entienda, 
// pero inyectamos la fecha de reproducción en el objeto
const tracksForList = trackItems.map(item => ({
  ...item.track,
  played_at: item.played_at // Pasamos esto para usarlo en el slot o custom render
}));
---

<Layout title="Historial de Reproducción">
  <main class="flex flex-col gap-8 px-4 md:px-8 py-12 max-w-7xl mx-auto isolate">
    
    <header class="flex flex-col md:flex-row md:items-end justify-between gap-6">
      <div class="flex flex-col gap-2">
        <h1 class="text-5xl md:text-7xl font-black tracking-tighter text-white italic">
          Historial<span class="text-[#1DB954]">.</span>
        </h1>
        <p class="text-zinc-500 text-sm font-medium italic antialiased">
          Tus últimas 50 reproducciones guardadas.
        </p>
      </div>

      <div class="flex items-center gap-2 bg-white/[0.03] p-1 rounded-full border border-white/10 w-fit">
        <span class="text-[9px] font-black uppercase tracking-widest text-zinc-500 px-3">Ver:</span>
        { [10, 20, 30, 50].map((num) => (
          <button 
            data-limit={num}
            class="limit-btn px-4 py-1.5 rounded-full text-[10px] font-bold transition-all duration-200 text-zinc-400 hover:text-white"
          >
            {num}
          </button>
        ))}
      </div>
    </header>

    <div class="history-container relative transition-opacity duration-300">
      <TrackList 
        tracks={tracksForList} 
        showAlbumColumn={true}
      />
    </div>
  </main>
</Layout>

<script>
  const buttons = document.querySelectorAll('.limit-btn');
  const rows = document.querySelectorAll('.track-row');

  function updateLimit(limit: number) {
    rows.forEach((row, index) => {
      if (index < limit) {
        (row as HTMLElement).style.display = 'grid';
      } else {
        (row as HTMLElement).style.display = 'none';
      }
    });

    // Actualizar estado visual de botones
    buttons.forEach(btn => {
      const isSelected = Number(btn.getAttribute('data-limit')) === limit;
      btn.classList.toggle('bg-[#1DB954]', isSelected);
      btn.classList.toggle('text-black', isSelected);
      btn.classList.toggle('text-zinc-400', !isSelected);
    });
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const limit = Number(btn.getAttribute('data-limit'));
      updateLimit(limit);
    });
  });

  // Inicializar con 20 por defecto
  updateLimit(20);
</script>

<style is:global>
  /* Optimización GPU: Solo renderizar lo que está cerca del viewport */
  .track-row {
    content-visibility: auto;
    contain-intrinsic-size: 1px 60px;
  }
</style>