---
// src/components/RecentTracks.astro
import type { RecentlyPlayed } from '../types/spotify';

const client_id = import.meta.env.SPOTIFY_CLIENT_ID;
const client_secret = import.meta.env.SPOTIFY_CLIENT_SECRET;
const refresh_token = import.meta.env.SPOTIFY_REFRESH_TOKEN;

// 1. Obtener Access Token mediante Refresh Token (TS estricto)
const basicAuth: string = Buffer.from(`${client_id}:${client_secret}`).toString('base64');

const tokenResponse = await fetch('https://accounts.spotify.com/api/token', {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${basicAuth}`,
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: refresh_token as string,
  }),
});

const tokenData = await tokenResponse.json();
const access_token: string = tokenData.access_token;

// 2. Consultar historial (Limitado a 10)
const recentTracksResponse = await fetch('https://api.spotify.com/v1/me/player/recently-played?limit=10', {
  headers: {
    'Authorization': `Bearer ${access_token}`,
  },
});

let trackItems: RecentlyPlayed['items'] = [];

if (recentTracksResponse.status === 200) {
  const data: RecentlyPlayed = await recentTracksResponse.json();
  trackItems = data.items || [];
}
---

<section class="max-w-[450px] rounded-2xl border border-zinc-800 bg-zinc-950 p-6 font-sans text-white shadow-2xl">
  <header class="mb-6 flex items-end justify-between border-b border-zinc-800 pb-3">
    <div class="flex flex-col gap-1">
      <span class="text-[10px] font-black uppercase tracking-[0.2em] text-[#1DB954]">Spotify</span>
      <h2 class="text-xl font-bold tracking-tight">Recientemente escuchado</h2>
    </div>
    
    <div class="flex h-5 items-end gap-[3px] px-1" aria-hidden="true">
      <div class="w-[3px] bg-[#1DB954] animate-music-1"></div>
      <div class="w-[3px] bg-[#1DB954] animate-music-2"></div>
      <div class="w-[3px] bg-[#1DB954] animate-music-3"></div>
    </div>
  </header>

  {trackItems.length > 0 ? (
    <div class="flex flex-col gap-2">
      {trackItems.map((item) => {
        // Usamos la interfaz SpotifyTrack['item'] a través de item.track
        const { track } = item;
        return (
          <a 
            href={track.external_urls.spotify} 
            target="_blank" 
            rel="noopener noreferrer" 
            class="group flex items-center gap-4 rounded-xl p-2 transition-all duration-300 hover:bg-white/5 active:scale-[0.98]"
          >
            <div class="relative h-12 w-12 flex-shrink-0 overflow-hidden rounded-md shadow-lg">
              <img 
                src={track.album.images[2]?.url || track.album.images[0]?.url} 
                alt={track.name} 
                loading="lazy"
                class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
              />
            </div>
            
            <div class="flex min-w-0 flex-1 flex-col">
              <span class="truncate text-sm font-bold leading-tight group-hover:text-[#1DB954] transition-colors">
                {track.name}
              </span>
              <span class="truncate text-[11px] font-medium text-zinc-500">
                {track.artists.map(a => a.name).join(', ')}
              </span>
            </div>

            <span class="translate-x-2 text-[#1DB954] opacity-0 transition-all duration-300 group-hover:translate-x-0 group-hover:opacity-100" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </span>
          </a>
        );
      })}
    </div>
  ) : (
    <div class="py-8 text-center">
      <p class="text-sm text-zinc-600 italic">No hay actividad reciente en tu cuenta.</p>
    </div>
  )}
</section>

<style>
  /* Animaciones custom para las barritas de música */
  @keyframes bounce {
    0% { height: 4px; }
    100% { height: 16px; }
  }

  .animate-music-1 { animation: bounce 0.6s infinite alternate; }
  .animate-music-2 { animation: bounce 0.8s infinite alternate 0.2s; }
  .animate-music-3 { animation: bounce 0.7s infinite alternate 0.4s; }
</style>