---
// src/components/tracks/TrackList.astro
interface Props {
  tracks: any[];
  artistName?: string;
  albumImage?: string;
  showAlbumColumn?: boolean;
  isTransparent?: boolean;
}

const { 
  tracks = [], 
  artistName, 
  albumImage, 
  showAlbumColumn = true, 
  isTransparent = false 
} = Astro.props;

const formatDuration = (ms: number) => {
  const min = Math.floor(ms / 60000);
  const sec = Math.floor((ms % 60000) / 1000);
  return `${min}:${sec.toString().padStart(2, '0')}`;
};
---

<div class:list={[
  "block overflow-hidden isolate contain-paint", 
  !isTransparent && "rounded-2xl border border-white/5 bg-white/[0.01] shadow-2xl"
]}>
  <div class="flex flex-col" id="track-container">
    {tracks.map((track, index) => {
      const artists = track.artists?.map((a: any) => a.name).join(', ') || artistName;
      const displayImage = track.album?.images?.[0]?.url || albumImage;

      return (
        <button 
          class="track-row group grid grid-cols-[40px_1fr_80px] md:grid-cols-[40px_2fr_1fr_80px] items-center gap-4 px-4 py-3 text-left border-b border-white/[0.02] last:border-0 w-full cursor-pointer hover:bg-white/[0.05] transition-colors duration-150"
          data-track={JSON.stringify({ name: track.name, artist: artists, image: displayImage })}
        >
          <div class="relative flex items-center justify-center h-full">
            <span class="text-[11px] font-bold text-zinc-600 group-hover:opacity-20 transition-opacity duration-300 font-mono antialiased">
              {(index + 1).toString().padStart(2, '0')}
            </span>
            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-[#1DB954] drop-shadow-[0_0_8px_rgba(29,185,84,0.4)]">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>

          <div class="flex flex-col min-w-0">
            <span class="truncate text-[13px] font-black text-white/90 group-hover:text-white transition-colors antialiased">
              {track.name}
            </span>
            <span class="truncate text-[10px] font-bold text-zinc-500 group-hover:text-[#1DB954] transition-colors uppercase tracking-tight antialiased">
              {artists}
            </span>
          </div>

          {showAlbumColumn && (
            <div class="hidden md:block truncate text-[11px] font-bold text-zinc-600 antialiased">
              {track.album?.name || ""}
            </div>
          )}

          <div class="flex items-center justify-end">
            <span class="text-[10px] text-zinc-600 font-mono font-bold group-hover:text-zinc-400 transition-colors antialiased">
              {formatDuration(track.duration_ms)}
            </span>
          </div>
        </button>
      );
    })}
  </div>
</div>

<script>
  const container = document.getElementById('track-container');
  if (container) {
    container.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.track-row') as HTMLElement;
      if (btn && btn.dataset.track) {
        document.dispatchEvent(new CustomEvent('spotify:play', { 
          detail: JSON.parse(btn.dataset.track)
        }));
      }
    });
  }
</script>