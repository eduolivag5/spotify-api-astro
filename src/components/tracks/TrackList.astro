---
interface Props {
  tracks: any[];
  artistName?: string;
  albumImage?: string;
  showAlbumColumn?: boolean;
  isTransparent?: boolean; // Nueva prop para quitar fondos si se desea
}

const { 
  tracks, 
  artistName, 
  albumImage, 
  showAlbumColumn = true, 
  isTransparent = false 
} = Astro.props;

const formatDuration = (ms: number) => {
  const min = Math.floor(ms / 60000);
  const sec = Math.floor((ms % 60000) / 1000);
  return `${min}:${sec.toString().padStart(2, '0')}`;
};
---

<spotify-tracklist 
  class:list={[
    "block overflow-hidden",
    !isTransparent && "rounded-2xl border border-zinc-800/40 bg-zinc-900/10 shadow-2xl"
  ]}
>
  <div class="flex flex-col">
    {tracks.map((track, index) => {
      const artists = track.artists?.map((a: any) => a.name).join(', ') || artistName;
      const displayAlbum = track.album?.name || "";
      const displayImage = track.album?.images?.[0]?.url || albumImage;

      return (
        <button 
          class="track-row group grid grid-cols-[32px_1fr_80px] md:grid-cols-[32px_2fr_1fr_80px] items-center gap-4 px-4 py-2.5 transition-all hover:bg-white/[0.06] text-left border-b border-white/[0.02] last:border-0 w-full"
          data-name={track.name}
          data-artist={artists}
          data-image={displayImage}
        >
          {/* Index / Play */}
          <div class="flex items-center justify-center relative">
            <span class="text-[10px] font-bold text-zinc-600 group-hover:opacity-0 transition-opacity font-mono">
              {(index + 1).toString().padStart(2, '0')}
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="absolute hidden group-hover:block text-[#1DB954]">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>

          {/* Título y Artistas */}
          <div class="flex flex-col min-w-0">
            <span class="truncate text-[13px] font-black text-white/90 group-hover:text-white transition-colors">
              {track.name}
            </span>
            <span class="truncate text-[10px] font-bold text-zinc-500 group-hover:text-[#1DB954] transition-colors uppercase tracking-tight">
              {artists}
            </span>
          </div>

          {/* Álbum (Opcional) */}
          {showAlbumColumn && (
            <div class="hidden md:block truncate text-[11px] font-bold text-zinc-600">
              {displayAlbum}
            </div>
          )}

          {/* Duración */}
          <div class="flex items-center justify-end font-mono">
            <span class="text-[10px] text-zinc-600 font-bold group-hover:text-zinc-400 transition-colors">
              {formatDuration(track.duration_ms)}
            </span>
          </div>
        </button>
      );
    })}
  </div>
</spotify-tracklist>

<script>
  if (!customElements.get('spotify-tracklist')) {
    customElements.define('spotify-tracklist', class extends HTMLElement {
      constructor() {
        super();
        this.addEventListener('click', (e) => {
          const btn = (e.target as HTMLElement).closest('.track-row') as HTMLElement;
          if (btn) {
            document.dispatchEvent(new CustomEvent('spotify:play', { 
              detail: { 
                name: btn.dataset.name,
                artist: btn.dataset.artist,
                image: btn.dataset.image
              } 
            }));
          }
        });
      }
    });
  }
</script>