---
import { getAlbum, getAlbumTracks } from "../../lib/spotify";
import TrackList from "../tracks/TrackList.astro";

interface Props {
  albumId: string;
}

const { albumId } = Astro.props;
const album = await getAlbum(albumId);
const allTracks = await getAlbumTracks(albumId);
const tracks = allTracks.slice(0, 3);

const albumUrl = `/album/${albumId}`;
---

<div class="group/container relative w-full rounded-2xl border border-white/10 bg-zinc-950/40 backdrop-blur-3xl overflow-hidden shadow-2xl transition-all duration-500 ease-out hover:border-white/20 will-change-transform">
  
  <div class="absolute inset-0 -z-10 overflow-hidden pointer-events-none">
    <img 
      src={album?.images[0]?.url} 
      class="glow-bg absolute -right-20 -top-20 w-[70%] opacity-20 saturate-200 transition-all duration-1000 ease-in-out group-hover/container:scale-110 group-hover/container:opacity-30"
      aria-hidden="true"
      loading="lazy"
    />
    <div class="absolute inset-0 bg-gradient-to-br from-white/[0.03] via-transparent to-black/40"></div>
  </div>

  <a href={albumUrl} class="absolute inset-0 z-10" aria-label={`Ir al 치lbum ${album?.name}`}></a>

  <div class="relative z-20 flex flex-col md:flex-row items-center gap-10 p-4 md:p-14 pointer-events-none">
    
    <div class="w-full md:w-[350px] flex-shrink-0">
      <div class="relative aspect-square rounded-2xl overflow-hidden shadow-[0_30px_60px_-15px_rgba(0,0,0,0.8)] transition-transform duration-500 ease-out group-hover/container:scale-[1.03] will-change-transform transform-gpu">
        <img 
          src={album?.images[0]?.url} 
          alt={album?.name}
          class="h-full w-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 ring-1 ring-inset ring-white/20 rounded-2xl"></div>
      </div>
    </div>

    <div class="w-full flex flex-col min-w-0">
      <div class="mb-8 px-2 transition-transform duration-500 ease-out group-hover/container:translate-x-1 will-change-transform transform-gpu">        
        <h3 class="text-3xl md:text-5xl font-black tracking-tighter text-white truncate italic leading-[0.8] mb-4 drop-shadow-2xl">
          {album?.name}
        </h3>
        
        <div class="flex items-center gap-3">
            <p class="text-sm font-bold text-zinc-300 uppercase tracking-[0.2em]">
                {album?.artists.map(a => a.name).join(', ')}
            </p>
            <span class="text-zinc-600 font-mono text-xs">/</span>
            <span class="text-zinc-500 font-mono text-xs tracking-tighter">
                {album?.release_date.split('-')[0]}
            </span>
        </div>
      </div>

      <div class="relative z-30 pointer-events-auto bg-white/[0.03] rounded-2xl border border-white/5 backdrop-blur-md p-3 shadow-inner group-hover/container:bg-white/[0.08] transition-colors duration-300">
        <TrackList 
          tracks={tracks} 
          albumImage={album?.images[0]?.url}
          showAlbumColumn={false}
          isTransparent={true}
        />
      </div>
    </div>
  </div>
</div>

<style>
  /* Forzamos a la GPU a crear una capa para el fondo blurreado */
  .glow-bg {
    filter: blur(80px); /* Bajamos de 100px a 80px: visualmente casi igual, computacionalmente mucho m치s barato */
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  .group\/container {
    transform: translateZ(0);
    backface-visibility: hidden;
    box-shadow: 
      0 30px 60px -12px rgba(0, 0, 0, 0.6),
      inset 0 1px 2px rgba(255, 255, 255, 0.1);
  }

  /* Reducimos el tiempo de transici칩n de colores, es mejor que sea r치pido si el blur es alto */
  :global(.track-row) {
    position: relative;
    z-index: 40;
    transition: background-color 0.2s ease-out;
  }
</style>